<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta charset="utf-8" />
    <title>Xenarius App Simulator</title>

    <script src="jquery-3.1.1.min.js"></script>
    <script src="simulator.orig.js"></script>
    <link rel="stylesheet" href="simulator.orig.css" />
    <link rel="stylesheet" href="simulator-toolbar.css" />
    <style type="text/css">
      .xet-popup-overlay {
        display: flex;
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        width: 100%;
        z-index: 1001;
        background-color: rgba(255, 255, 255, 0.8);
        align-items: center;
      }
      .xet-popup {
        box-sizing: border-box;
        position: relative;
        margin: auto;
        width: 500px;
        border: 1px solid #dddddd;
        border-radius: 6px;
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.175);
        background-color: white;
        padding: 30px;
        font-size: 14px;
      }
      .xet-popup > .xet-button-close {
        position: absolute;
        top: 0;
        right: 0;
      }
      .xet-popup-content {
        display: flex;
        flex-direction: column;
      }
      .xet-popup-content * {
        margin: auto;
      }
      .xet-popup-content > *:not(:first-child) {
        margin-top: 10px;
      }
      .xet-popup-icon {
        height: 75px;
        width: 75px;
      }
      .xet-popup-title {
        font-size: 150%;
      }
      .xet-popup-message a {
        color: #5f5f5f;
      }
      .xet-popup-button-close {
        border: 1px solid #dddddd;
        border-radius: 4px;
        box-shadow: 0 1px 3px transparent;
        padding: 7px 18px 8px;
        cursor: pointer;
        font-size: 14px;
      }
      .xet-popup-button-close:hover {
        background-color: #e6e6e6;
        border-color: #bebebe;
      }
    </style>

    <script type="text/javascript">
      $(function() {
        var DEVICE_KEY = "dx-simulator-device-name",
          OS_VERSION_NUMBER_KEY = "dx-simulator-os-version-number",
          ORIENTATION_KEY = "dx-simulator-orientation",
          SCALE_KEY = "dx-simulator-scale";

        var defaultSettings = {
          "dx-simulator-device-name": "iPhone5",

          "dx-simulator-scale": 1,
          "dx-simulator-orientation": "p",
          "dx-simulator-os-version-number": undefined,

          "dx-simulator-scale-iPadMini": 1,
          "dx-simulator-orientation-iPadMini": "l",
          "dx-simulator-os-version-number-iPadMini": 7,

          "dx-simulator-scale-iPhone5": 1,
          "dx-simulator-orientation-iPhone5": "p",
          "dx-simulator-os-version-number-iPhone5": 7
        };
        if (localStorage.getItem("dx-simulator-device-name")) {
          defaultSettings["dx-simulator-device-name"] = localStorage.getItem(
            "dx-simulator-device-name"
          );
        }
        function isStorageAvailable(storageType) {
          try {
            var storage = window[storageType];
            var x = "__mdn__storage__test__";
            storage.setItem(x, x);
            storage.removeItem(x);
            isStorageAvailable = function() {
              return true;
            };
            return true;
          } catch (e) {
            isStorageAvailable = function() {
              return false;
            };
            return false;
          }
        }

        var readSettings = function(key) {
            var value =
              window.sessionStorage &&
              isStorageAvailable("sessionStorage") &&
              sessionStorage.getItem(key);
            return value || defaultSettings[key];
          },
          readDeviceSettings = function(key, device) {
            var deviceKey = key + "-" + device;
            return readSettings(deviceKey) || defaultSettings[key];
          },
          writeSettings = function(key, value) {
            if (window.sessionStorage && isStorageAvailable("sessionStorage")) {
              sessionStorage.setItem(key, value);
            }
          },
          writeDeviceSettings = function(key, device, value) {
            var deviceKey = key + "-" + device;
            writeSettings(deviceKey, value);
          };

        var queryStringToObject = function(queryString) {
          var result = {};

          if (queryString.charAt(0) === "?")
            queryString = queryString.substring(1);

          var chunks = queryString.split("&");

          $.each(chunks, function() {
            var equalPos = this.indexOf("=");
            var key = decodeURIComponent(this.substr(0, equalPos)),
              value = decodeURIComponent(this.substr(equalPos + 1));
            result[key] = value;
          });

          return result;
        };

        var query = queryStringToObject(window.location.search),
          appPage = query["appPage"] || "app.html",
          device = readSettings(DEVICE_KEY),
          simulator = $("#simulatorFrame").dxSimulator({
            returnInstance: true,
            url: appPage,
            device: device,
            osVersionNumber: readDeviceSettings(OS_VERSION_NUMBER_KEY, device),
            orientation: readDeviceSettings(ORIENTATION_KEY, device),
            scale: readDeviceSettings(SCALE_KEY, device),
            wrapFrame: true,
            loadIndicator: $("#loadingIndicator")
          });

        var $orientationToolbarItem = $(".toolbar-item.rotate"),
          setOrientation = function(orientation) {
            simulator.options("orientation", orientation);
            var device = simulator.options("device");
            writeDeviceSettings(ORIENTATION_KEY, device, orientation);
            $orientationToolbarItem.toggle(device !== "desktop");
          };
        $orientationToolbarItem.on("click", function() {
          var orientation = simulator.options("orientation");
          orientation = orientation === "l" ? "p" : "l";
          setOrientation(orientation);
        });

        var $zoomToolbarItem = $(".toolbar-item.zoom"),
          setScale = function(scale) {
            simulator.options("scale", scale);
            var device = simulator.options("device");
            writeDeviceSettings(SCALE_KEY, device, simulator.options("scale"));
            $zoomToolbarItem.toggleClass("zoom-in", scale === "0.5");
            $zoomToolbarItem.toggle(device !== "desktop");
          };
        $zoomToolbarItem.on("click", function() {
          var scale = simulator.options("scale");
          scale = scale === "0.5" ? "1.0" : "0.5";
          setScale(scale);
        });

        var $debugToolbarItem = $(".toolbar-item.debug");
        $debugToolbarItem.on("click", function() {
          if (window.ga) {
            ga("send", "event", "Buttons", "Simulator", "Debug", 1);
          }
          alert(
            "We are sorry, you've found a feature that's not ready yet. Business logic debugging is currently not available. So far we're collecting statistics to estimate the demand for various features, which helps us implement the most popular features first. Your vote has been counted."
          );
        });

        // device chooser
        var $deviceChooser = $(".device-toolbar"),
          setDevice = function(device) {
            // Desktop mode navigation doesn't work inside <iframe>, open a new tab instead.
            if (device === "desktop") {
              window.open(appPage, "desktop-simulator");
              return;
            }
            simulator.options({
              device: device,
              osVersionNumber: readDeviceSettings(OS_VERSION_NUMBER_KEY, device)
            });
            writeSettings(DEVICE_KEY, device);
            writeDeviceSettings(
              OS_VERSION_NUMBER_KEY,
              device,
              simulator.options("osVersionNumber")
            );
            $deviceChooser.find(".device").each(function() {
              var $this = $(this);
              $this.toggleClass("active", $this.attr("data-device") === device);
            });

            var scale = readDeviceSettings(SCALE_KEY, device);
            setScale(scale);

            var orientation = readDeviceSettings(ORIENTATION_KEY, device);
            setOrientation(orientation);
          };
        $deviceChooser.on("click", ".device", function() {
          setDevice($(this).attr("data-device"));
          return false;
        });

        setDevice(simulator.options("device"));

        $("#simulatorFrame").on("load", function() {
          var proxyUrl =
            queryStringToObject(window.location.search)["proxyUrl"] ||
            this.contentWindow.location;
          $("#qr").attr(
            "src",
            "https://api.qrserver.com/v1/create-qr-code/?size=90x90&data=" +
              encodeURIComponent(proxyUrl)
          );
          $("#qr-link").attr("href", proxyUrl);
        });

        var frameWindow = simulator._frameWindow();
        $(simulator).on("appstarted", function() {
          var application = frameWindow.app.instance;
          application.on("dataError", function(e) {
            var error = e.error;
            if (error.httpStatus === 0 && error.statusText === "error") {
              e.handled = true;
              var htmlMessage =
                  error.message +
                  " Ensure that the server returns correct CORS headers.<br><a href='https://xenarius.net/docs/cors/' target='_blank'>Read more about CORS</a>",
                $popup = $("#xet-warning-popup");
              $popup
                .find(".xet-popup-title")
                .text("Your service doesn't support CORS");
              $popup.find(".xet-popup-message").html(htmlMessage);
              $popup.show();
            }
          });
        });

        $(".xet-popup-button-close").click(function() {
          var $popup = $(this).closest(".xet-popup-overlay");
          $popup.hide();
        });

        window.addEventListener("message", function(event) {
          if (event.data && event.data.toString().indexOf("app-json:") === 0) {
            var data = event.data.toString().slice("app-json:".length);
            if (isStorageAvailable("sessionStorage")) {
              sessionStorage.setItem("json", data);
            } else {
              window.json = data;
            }
            var dxapp = frameWindow.AppPlayer.Application.get().dxapp;
            dxapp.saveState();
            frameWindow.location.reload();
          }
        });
      });
    </script>
  </head>
  <body>
    <div class="wrapper">
      <div class="sidebar">
        <div class="logo"></div>
        <div class="device-toolbar">
          <div class="toolbar-item qr-code">
            <div class="qr-code-container">
              <a href="#" id="qr-link" target="_blank">
                <img id="qr" src="" class="qr-code" />
              </a>
              <p>Use QR-code reader to install the app on your phone.</p>
            </div>
          </div>
          <div class="toolbar-item device" data-device="desktop">
            <div class="center-center">
              <img class="normal" src="images/icon_desktop.png" alt="desktop" />
              <img
                class="active"
                src="images/icon_desktop_active.png"
                alt="desktop_active"
              />
              <div>Desktop</div>
            </div>
          </div>
          <div class="toolbar-item device" data-device="iPadMini">
            <div class="center-center">
              <img class="normal" src="images/icon_tablet.png" alt="tablet" />
              <img
                class="active"
                src="images/icon_tablet_active.png"
                alt="tablet_active"
              />
              <div>Tablet</div>
            </div>
          </div>
          <div class="toolbar-item device" data-device="iPhone5">
            <div class="center-center">
              <img class="normal" src="images/icon_phone.png" alt="phone" />
              <img
                class="active"
                src="images/icon_phone_active.png"
                alt="phone_active"
              />
              <div>Phone</div>
            </div>
          </div>
        </div>
        <div class="device-options-toolbar">
          <div class="toolbar-item debug">
            <div class="center-center">
              <img src="images/icon_debug.png" alt="rotate" />
              <div>Debug</div>
            </div>
          </div>
          <div class="toolbar-item zoom">
            <div class="center-center">
              <img src="images/icon_zoom.png" alt="zoom" />
              <div class="zoom-in">Zoom in</div>
              <div class="zoom-out">Zoom out</div>
            </div>
          </div>
          <div class="toolbar-item rotate">
            <div class="center-center">
              <img src="images/icon_rotate.png" alt="rotate" />
              <div>Rotate</div>
            </div>
          </div>
        </div>
      </div>
      <div class="main">
        <iframe id="simulatorFrame" scrolling="no" border="0"></iframe>
        <div id="loadingIndicator" class="spinner">
          <div class="double-bounce1"></div>
          <div class="double-bounce2"></div>
        </div>
        <p class="devtools-notice">
          <img src="images/idea.svg" width="40" height="40" />
          To analyze the application's network activity, use Developer Tools in
          your browser. Press F12 or Ctrl+Shift+I in Windows or Command+Option+I
          on the Mac to open the tools.
        </p>
      </div>
    </div>
    <div
      id="xet-warning-popup"
      class="xet-popup-overlay"
      style="display: none;"
    >
      <div class="xet-popup">
        <div class="xet-popup-content">
          <div class="xet-popup-icon"><img src="images/warning.svg" /></div>
          <div class="xet-popup-title"></div>
          <div class="xet-popup-message"></div>
          <div class="xet-popup-button-close">Close</div>
        </div>
      </div>
    </div>
  </body>
</html>
